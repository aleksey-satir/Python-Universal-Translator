#!/usr/bin/python3.9
import sys
import subprocess
from typing import List, Optional

import yaml
import typer
from jinja2 import Template

from transPYler import core


yaml.warnings({'YAMLLoadWarning': False})

def add_templ(t):
    tmpls = yaml.load(open(t, 'r').read())
    for i in tmpls:
        if i not in ['operations', 'types']:
            tmpls[i] = Template(tmpls.get(i))
    core.tmpls |= tmpls

def add_macros(m):
    core.macros |= yaml.load(open(m, 'r').read())
    if 'classes' in core.macros:
        core.objects |= core.macros.get('classes')

def main(
        _file: typer.FileText = typer.Argument(
            'index.py',
            help='Name of file for transpilation'
        ),
        tmpl: Optional[List[str]] = typer.Option(
            None,
            help='Names of template file(templates for js translators/js)'
        ),
        macr: Optional[List[str]] = typer.Option(
            [],
            help='Names of macros file(macros for js translators/js/macros.tp)'
        ),
        out: typer.FileTextWrite = typer.Option(
            sys.stdout,
            help='Output file'
        ),
):
    if not(tmpl):
        typer.echo('You must send at least one template file')
        raise typer.Abort()
    for t in tmpl:
        add_templ(t)
    for m in macr:
        add_macros(m)
    src = core.compiler(_file.read())
    print(src, file=out)

if __name__ == '__main__':
     typer.run(main)
